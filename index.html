<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 家族瀨戶內海旅遊計畫</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .drag-ghost { opacity: 0.5; background: #ebf5ff; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .expanded .collapsible-content { max-height: 1000px; }
    </style>
</head>
<body class="pb-10">

    <!-- Banner 區域 -->
    <div class="relative w-full h-64 md:h-80 overflow-hidden bg-gray-200">
        <img src="2026.jpg" alt="2026 Family Trip Banner" class="w-full h-full object-cover" onerror="this.src='https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?auto=format&fit=crop&w=1200&q=753'">
        <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center">
            <h1 class="text-white text-3xl md:text-5xl font-bold tracking-widest drop-shadow-lg">2026 家族瀨戶內海旅遊計畫</h1>
        </div>
    </div>

    <!-- 主要內容 -->
    <main class="max-w-4xl mx-auto mt-6 px-4">
        <div id="itinerary-list" class="space-y-4">
            <!-- 每日行程將由 JS 生成 -->
        </div>
    </main>

    <footer class="text-center mt-10 text-gray-500 text-sm">
        <p>© 2026 Family Trip Planner - 天氣數據自動更新</p>
    </footer>

    <script>
        const initialData = [
            { date: "2026-02-11", day: "Day 1", city: "大阪", location: "Osaka", mainPath: "桃園 → 大阪", items: ["關西機場", "大阪市區散策"] },
            { date: "2026-02-12", day: "Day 2", city: "下關", location: "Shimonoseki", mainPath: "下關、防府", items: ["唐戶市場", "海峽夢之塔", "關門隧道步道", "防府天滿宮"] },
            { date: "2026-02-13", day: "Day 3", city: "宮島", location: "Hatsukaichi", mainPath: "岩國、宮島", items: ["錦帶橋", "岩國城", "嚴島神社", "宮島表參道商店街"] },
            { date: "2026-02-14", day: "Day 4", city: "廣島", location: "Hiroshima", mainPath: "廣島", items: ["原爆圓頂", "和平紀念公園", "廣島城"] },
            { date: "2026-02-15", day: "Day 5", city: "大久野島", location: "Takehara", mainPath: "大久野島、竹原", items: ["兔子島", "竹原街景保存地區"] },
            { date: "2026-02-16", day: "Day 6", city: "尾道", location: "Onomichi", mainPath: "尾道、鞆之浦", items: ["千光寺", "貓之細道", "鞆之浦"] },
            { date: "2026-02-17", day: "Day 7", city: "豐島・直島", location: "Naoshima", mainPath: "豐島・直島", items: ["豐島美術館", "針工廠", "ANDO MUSEUM", "李禹煥美術館"] },
            { date: "2026-02-18", day: "Day 8", city: "倉敷", location: "Kurashiki", mainPath: "倉敷、吉備津", items: ["倉敷美觀地區", "吉備津神社","瀨戶大橋","鷲羽山"] },
            { date: "2026-02-19", day: "Day 9", city: "姬路、備前、神戶", location: "Himeji", mainPath: "姬路、備前、神戶", items: ["明石海峽大橋", "摩耶山掬星台","舊閑谷學校","天津神社"] },
            { date: "2026-02-20", day: "Day 10", city: "神戶", location: "Kobe", mainPath: "神戶", items: ["神戶舊居留地"] },
            { date: "2026-02-21", day: "Day 11", city: "大阪", location: "Osaka", mainPath: "大阪", items: ["心齋橋", "道頓堀"] }
        ];

        const cityCoords = {
            "Osaka": [34.69, 135.50],
            "Shimonoseki": [33.95, 130.94],
            "Hatsukaichi": [34.35, 132.33],
            "Hiroshima": [34.38, 132.45],
            "Takehara": [34.34, 132.91],
            "Onomichi": [34.40, 133.20],
            "Kurashiki": [34.58, 133.77],
            "Naoshima": [34.45, 133.99],
            "Himeji": [34.81, 134.69],
            "Kobe": [34.69, 135.18]
        };

        function getWeatherInfo(code) {
            const map = {
                0: { icon: 'sun', text: '晴朗', advice: '天氣晴朗，適合戶外活動。' },
                1: { icon: 'cloud-sun', text: '晴時多雲', advice: '天氣舒適，薄長袖即可。' },
                2: { icon: 'cloud', text: '多雲', advice: '雲量較多，早晚微涼。' },
                3: { icon: 'cloud', text: '陰天', advice: '陰天，建議帶件輕便外套。' },
                45: { icon: 'cloud-fog', text: '有霧', advice: '視線不佳，請注意安全。' },
                51: { icon: 'cloud-rain', text: '毛毛雨', advice: '小雨，建議攜帶折疊傘。' },
                61: { icon: 'cloud-rain', text: '陣雨', advice: '請務必攜帶雨具，預防淋濕。' },
                71: { icon: 'snowflake', text: '小雪', advice: '氣溫極低，請加強保暖。' }
            };
            return map[code] || { icon: 'cloud', text: '穩定', advice: '二月關西偏冷，請注意保暖。' };
        }

        // 顯示天氣的輔助函數
        function displayWeather(dayId, minT, maxT, code) {
            const container = document.getElementById(`weather-${dayId}`);
            const info = getWeatherInfo(code);
            container.innerHTML = `
                <div class="flex items-center gap-3 bg-white p-3 rounded-lg border border-blue-100 shadow-sm">
                    <i data-lucide="${info.icon}" class="text-blue-500 w-8 h-8"></i>
                    <div>
                        <div class="text-sm font-bold text-gray-800">${minT}°C - ${maxT}°C · ${info.text}</div>
                        <div class="text-xs text-gray-500">${info.advice}</div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        // 帶有重試機制與備援的天氣抓取
        async function fetchWeatherWithRetry(lat, lon, dayId, retries = 5, delay = 1000) {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo`;
            
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    
                    const code = data.daily.weathercode[0];
                    const maxT = Math.round(data.daily.temperature_2m_max[0]);
                    const minT = Math.round(data.daily.temperature_2m_min[0]);
                    
                    displayWeather(dayId, minT, maxT, code);
                    return;
                } catch (e) {
                    if (i === retries - 1) {
                        console.error(`Final attempt failed for day ${dayId}:`, e);
                        // 最終失敗時顯示歷史平均預估值（二月日本關西約 3-10度）
                        displayWeather(dayId, 3, 10, 2); 
                    } else {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // 指數退避
                    }
                }
            }
        }

        function renderApp() {
            const list = document.getElementById('itinerary-list');
            list.innerHTML = '';

            initialData.forEach((day, index) => {
                const dayCard = document.createElement('div');
                dayCard.className = "bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden day-card";
                dayCard.id = `day-${index}`;
                
                dayCard.innerHTML = `
                    <div class="p-4 cursor-pointer hover:bg-gray-50 flex flex-col md:flex-row md:items-center justify-between gap-4" onclick="this.parentElement.classList.toggle('expanded')">
                        <div class="flex items-start gap-4">
                            <div class="bg-blue-600 text-white p-2 rounded-lg text-center min-w-[60px]">
                                <div class="text-xs uppercase font-bold">${day.day}</div>
                                <div class="text-lg font-bold">${day.date.split('-')[2]}</div>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg text-gray-800">${day.mainPath}</h3>
                                <p class="text-sm text-gray-500">${day.city}</p>
                            </div>
                        </div>
                        <div id="weather-${index}" class="min-w-[200px]">
                            <div class="animate-pulse bg-gray-100 h-12 rounded-lg"></div>
                        </div>
                    </div>
                    
                    <div class="collapsible-content bg-gray-50 border-t border-gray-100">
                        <div class="p-4">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-sm font-bold text-gray-600">建議景點 (可拖曳排序)</span>
                                <button onclick="event.stopPropagation(); addItem(${index})" class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">+ 新增景點</button>
                            </div>
                            <ul id="list-${index}" class="space-y-2 sortable-list">
                                ${day.items.map((item, i) => `
                                    <li class="flex items-center justify-between bg-white p-3 rounded border border-gray-200 shadow-sm group">
                                        <div class="flex items-center gap-3 flex-1">
                                            <i data-lucide="grip-vertical" class="text-gray-300 w-4 h-4 cursor-move"></i>
                                            <a href="https://www.google.com/search?q=${day.city}+${encodeURIComponent(item)}" target="_blank" class="text-blue-600 hover:underline flex-1">${item}</a>
                                        </div>
                                        <button onclick="event.stopPropagation(); removeItem(${index}, ${i})" class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <i data-lucide="x" class="w-4 h-4"></i>
                                        </button>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                `;
                list.appendChild(dayCard);
                
                const coords = cityCoords[day.location] || [34.69, 135.50];
                fetchWeatherWithRetry(coords[0], coords[1], index);

                new Sortable(document.getElementById(`list-${index}`), {
                    animation: 150,
                    handle: '.cursor-move',
                    ghostClass: 'drag-ghost'
                });
            });
            lucide.createIcons();
        }

        window.addItem = function(dayIndex) {
            const newItem = prompt("請輸入景點名稱：");
            if (newItem) {
                initialData[dayIndex].items.push(newItem);
                renderApp();
            }
        };

        window.removeItem = function(dayIndex, itemIndex) {
            if (confirm("確定要刪除此景點嗎？")) {
                initialData[dayIndex].items.splice(itemIndex, 1);
                renderApp();
            }
        };

        document.addEventListener('DOMContentLoaded', renderApp);
    </script>
</body>
</html>

