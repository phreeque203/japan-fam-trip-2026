import React, { useState, useEffect } from 'react';
import { 
  CloudSun, 
  MapPin, 
  Car, 
  ChevronDown, 
  ChevronUp, 
  Plus, 
  Trash2, 
  GripVertical, 
  Camera, 
  Info,
  ExternalLink,
  Calendar,
  Loader2,
  Navigation
} from 'lucide-react';

// --- 完整的行程資料 (根據 CSV 內容) ---
const fullItinerary = [
  {
    id: 'day1',
    date: '2026-02-11',
    dayText: 'Day 1',
    city: '大阪',
    spots: [
      { id: 's1-1', name: '桃園機場 CI156 (08:10-11:35)', duration: '航班', travelTime: '0' },
      { id: 's1-2', name: '大阪港 名門大洋渡輪 (19:50發)', duration: '登船', travelTime: '60' }
    ]
  },
  {
    id: 'day2',
    date: '2026-02-12',
    dayText: 'Day 2',
    city: '下關/防府',
    spots: [
      { id: 's2-1', name: '唐戶市場', duration: '海鮮美食', travelTime: '30' },
      { id: 's2-2', name: '海峽夢之塔', duration: '展望台', travelTime: '15' },
      { id: 's2-3', name: '關門隧道步道', duration: '跨海步行', travelTime: '20' },
      { id: 's2-4', name: '防府天滿宮', duration: '神社', travelTime: '45' }
    ]
  },
  {
    id: 'day3',
    date: '2026-02-13',
    dayText: 'Day 3',
    city: '岩國/宮島',
    spots: [
      { id: 's3-1', name: '錦帶橋', duration: '木造橋', travelTime: '40' },
      { id: 's3-2', name: '岩國城', duration: '天守閣', travelTime: '20' },
      { id: 's3-3', name: '嚴島神社 (大鳥居)', duration: '世界遺產', travelTime: '60' },
      { id: 's3-4', name: '宮島表參道商店街', duration: '購物/點心', travelTime: '10' }
    ]
  },
  {
    id: 'day4',
    date: '2026-02-14',
    dayText: 'Day 4',
    city: '廣島',
    spots: [
      { id: 's4-1', name: '原爆圓頂', duration: '歷史遺跡', travelTime: '30' },
      { id: 's4-2', name: '和平紀念公園', duration: '散步', travelTime: '5' }
    ]
  },
  {
    id: 'day5',
    date: '2026-02-15',
    dayText: 'Day 5',
    city: '大久野島/竹原',
    spots: [
      { id: 's5-1', name: '大久野島 (兔子島)', duration: '親近動物', travelTime: '50' },
      { id: 's5-2', name: '竹原街景保存地區', duration: '小京都風情', travelTime: '40' }
    ]
  },
  {
    id: 'day6',
    date: '2026-02-16',
    dayText: 'Day 6',
    city: '尾道/鞆之浦',
    spots: [
      { id: 's6-1', name: '千光寺 (纜車)', duration: '展望美景', travelTime: '30' },
      { id: 's6-2', name: '貓之細道', duration: '散步', travelTime: '10' },
      { id: 's6-3', name: '鞆之浦', duration: '古老漁村', travelTime: '45' }
    ]
  },
  {
    id: 'day7',
    date: '2026-02-17',
    dayText: 'Day 7',
    city: '倉敷/吉備津',
    spots: [
      { id: 's7-1', name: '倉敷美觀地區', duration: '運河老街', travelTime: '30' },
      { id: 's7-2', name: '吉備津神社', duration: '長廊', travelTime: '25' },
      { id: 's7-3', name: '岡山後樂園', duration: '日本三名園', travelTime: '20' }
    ]
  },
  {
    id: 'day8',
    date: '2026-02-18',
    dayText: 'Day 8',
    city: '岡山/桃園',
    spots: [
      { id: 's8-1', name: '岡山AEON Mall', duration: '最後購物', travelTime: '15' },
      { id: 's8-2', name: '岡山機場 IT215 (15:55-17:40)', duration: '回程航班', travelTime: '40' }
    ]
  }
];

const apiKey = ""; // API Key 會由環境注入

const App = () => {
  const [itinerary, setItinerary] = useState(fullItinerary);
  const [expandedDays, setExpandedDays] = useState(['day1']);
  const [bannerUrl, setBannerUrl] = useState('https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?auto=format&fit=crop&q=80&w=1200');
  const [weatherData, setWeatherData] = useState({});
  const [loadingWeather, setLoadingWeather] = useState(false);
  const [draggedItem, setDraggedItem] = useState(null);

  // --- 獲取個別日期與城市的天氣預報 ---
  const fetchWeatherAdvice = async () => {
    setLoadingWeather(true);
    try {
      const weatherPrompt = itinerary.map(d => `${d.date} ${d.city}`).join(', ');
      const systemPrompt = "你是一位日本旅遊專家。請針對提供的日期與城市，預測當地的平均氣溫、天氣狀況及穿著建議。請以繁體中文回答，並僅回傳 JSON 格式。";
      const userQuery = `請提供以下清單的天氣資訊：${weatherPrompt}。JSON 格式必須為：{"日期": {"temp": "x-y°C", "condition": "晴/陰/雨", "advice": "穿著建議"}}`;

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: userQuery }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          generationConfig: { responseMimeType: "application/json" }
        })
      });

      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
      if (text) {
        setWeatherData(JSON.parse(text));
      }
    } catch (error) {
      console.error("天氣獲取失敗", error);
    } finally {
      setLoadingWeather(false);
    }
  };

  useEffect(() => {
    fetchWeatherAdvice();
  }, []);

  const toggleDay = (id) => {
    setExpandedDays(prev => 
      prev.includes(id) ? prev.filter(item => item !== id) : [...prev, id]
    );
  };

  const handleBannerChange = () => {
    const newUrl = prompt("請輸入新的 Banner 圖片網址:", bannerUrl);
    if (newUrl) setBannerUrl(newUrl);
  };

  const addSpot = (dayId) => {
    const spotName = prompt("請輸入新景點名稱:");
    if (!spotName) return;
    const travelTime = prompt("從上個點過來的車程 (分鐘):", "30");
    setItinerary(prev => prev.map(day => {
      if (day.id === dayId) {
        return {
          ...day,
          spots: [...day.spots, { id: Date.now().toString(), name: spotName, duration: '', travelTime: travelTime || '0' }]
        };
      }
      return day;
    }));
  };

  const deleteSpot = (dayId, spotId) => {
    if (!confirm("確定刪除？")) return;
    setItinerary(prev => prev.map(day => {
      if (day.id === dayId) {
        return { ...day, spots: day.spots.filter(s => s.id !== spotId) };
      }
      return day;
    }));
  };

  const handleDragStart = (e, dayId, index) => setDraggedItem({ dayId, index });
  const handleDragOver = (e, dayId, index) => {
    e.preventDefault();
    if (!draggedItem || draggedItem.dayId !== dayId) return;
    const newItinerary = [...itinerary];
    const dIdx = newItinerary.findIndex(d => d.id === dayId);
    const spots = [...newItinerary[dIdx].spots];
    const item = spots.splice(draggedItem.index, 1)[0];
    spots.splice(index, 0, item);
    newItinerary[dIdx].spots = spots;
    setItinerary(newItinerary);
    setDraggedItem({ dayId, index });
  };

  return (
    <div className="min-h-screen bg-gray-50 pb-20 font-sans text-gray-900">
      {/* Banner */}
      <div className="relative h-72 md:h-96 w-full overflow-hidden">
        <img src={bannerUrl} alt="Banner" className="w-full h-full object-cover" />
        <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex flex-col items-center justify-center text-white">
          <h1 className="text-4xl md:text-6xl font-black mb-2 tracking-widest drop-shadow-xl">2026 家族旅遊</h1>
          <p className="text-xl font-light tracking-widest opacity-90 underline decoration-blue-400 underline-offset-8">山陽地區・深度之旅</p>
          <button 
            onClick={handleBannerChange}
            className="absolute top-4 right-4 bg-white/20 hover:bg-white/40 backdrop-blur-md p-2 rounded-full"
          >
            <Camera size={20} />
          </button>
        </div>
      </div>

      {/* Itinerary */}
      <div className="max-w-4xl mx-auto px-4 -mt-10 relative z-10">
        <div className="space-y-6">
          {itinerary.map((day) => {
            const isExpanded = expandedDays.includes(day.id);
            const weather = weatherData[day.date]; // 精準對比日期獲取天氣

            return (
              <div key={day.id} className="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-hidden">
                {/* Header */}
                <div 
                  className="p-6 cursor-pointer flex flex-col lg:flex-row lg:items-center justify-between gap-4"
                  onClick={() => toggleDay(day.id)}
                >
                  <div className="flex items-center gap-5">
                    <div className="bg-blue-600 text-white w-16 h-16 rounded-2xl flex flex-col items-center justify-center flex-shrink-0 shadow-lg">
                      <span className="text-xs font-bold uppercase tracking-tighter">{day.dayText}</span>
                      <span className="text-lg font-bold">{day.date.split('-')[2]}日</span>
                    </div>
                    <div>
                      <h2 className="text-2xl font-black text-gray-800 flex items-center gap-2">
                        {day.city}
                        <Navigation size={18} className="text-blue-500 rotate-45" />
                      </h2>
                      <p className="text-sm font-medium text-gray-400">{day.date}</p>
                    </div>
                  </div>

                  {/* Weather Information - Always Visible */}
                  <div className="flex items-center gap-4 bg-gray-50 p-4 rounded-2xl border border-gray-100 w-full lg:w-auto">
                    {loadingWeather ? (
                      <div className="flex items-center gap-2 text-blue-500 font-medium">
                        <Loader2 size={18} className="animate-spin" />
                        <span>更新天氣中...</span>
                      </div>
                    ) : (
                      <div className="flex flex-col md:flex-row items-start md:items-center gap-3">
                        <div className="flex items-center gap-2">
                          <CloudSun size={24} className="text-orange-400" />
                          <span className="text-xl font-bold text-gray-700">{weather?.temp || "4-11°C"}</span>
                          <span className="px-2 py-0.5 bg-blue-100 text-blue-600 text-xs rounded-full font-bold">
                            {weather?.condition || "預測"}
                          </span>
                        </div>
                        <div className="hidden md:block h-8 w-px bg-gray-200"></div>
                        <div className="flex items-start gap-2">
                          <Info size={16} className="text-blue-400 mt-0.5 flex-shrink-0" />
                          <p className="text-sm text-gray-500 leading-tight">
                            {weather?.advice || "日本二月氣候寒冷且乾燥，建議穿著發熱衣、羊蔥式穿法，並隨身攜帶保暖小物。"}
                          </p>
                        </div>
                      </div>
                    )}
                    <div className="ml-auto">
                      {isExpanded ? <ChevronUp className="text-gray-300" /> : <ChevronDown className="text-gray-300" />}
                    </div>
                  </div>
                </div>

                {/* Spots */}
                {isExpanded && (
                  <div className="px-6 pb-8 border-t border-gray-50 animate-in fade-in slide-in-from-top-4 duration-500">
                    <div className="mt-6 space-y-4">
                      {day.spots.map((spot, index) => (
                        <div key={spot.id}>
                          {index > 0 && (
                            <div className="flex items-center gap-3 ml-12 my-2 text-gray-400 text-xs font-bold">
                              <div className="w-0.5 h-6 bg-gradient-to-b from-gray-200 to-transparent ml-1"></div>
                              <Car size={14} className="text-blue-300" />
                              <span>預計車程 {spot.travelTime} 分鐘</span>
                            </div>
                          )}

                          <div 
                            draggable
                            onDragStart={(e) => handleDragStart(e, day.id, index)}
                            onDragOver={(e) => handleDragOver(e, day.id, index)}
                            className="group flex items-center gap-4 bg-white p-5 rounded-2xl border border-gray-100 shadow-sm hover:border-blue-400 hover:shadow-lg transition-all cursor-move"
                          >
                            <GripVertical className="text-gray-200 group-hover:text-blue-400" size={20} />
                            <div className="flex-grow">
                              <div className="flex items-center justify-between">
                                <a 
                                  href={`https://www.google.com/search?q=${encodeURIComponent(day.city + ' ' + spot.name)}`}
                                  target="_blank"
                                  className="text-lg font-bold text-gray-700 hover:text-blue-600 transition-colors flex items-center gap-2"
                                >
                                  {spot.name}
                                  <ExternalLink size={14} className="opacity-0 group-hover:opacity-100 text-gray-300" />
                                </a>
                                <button 
                                  onClick={() => deleteSpot(day.id, spot.id)}
                                  className="text-gray-200 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"
                                >
                                  <Trash2 size={18} />
                                </button>
                              </div>
                              {spot.duration && (
                                <p className="text-xs font-bold text-blue-500 mt-1 flex items-center gap-1">
                                  <Calendar size={12} /> {spot.duration}
                                </p>
                              )}
                            </div>
                          </div>
                        </div>
                      ))}

                      <button 
                        onClick={() => addSpot(day.id)}
                        className="w-full py-4 border-2 border-dashed border-gray-200 rounded-2xl text-gray-400 hover:text-blue-500 hover:border-blue-200 hover:bg-blue-50 transition-all flex items-center justify-center gap-2 mt-6 font-bold text-sm"
                      >
                        <Plus size={20} /> 新增行程點
                      </button>
                    </div>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      </div>
      <footer className="mt-16 text-center text-gray-400 text-xs font-medium uppercase tracking-widest pb-10">
        Created for 2026 Family Trip • Data by Gemini
      </footer>
    </div>
  );
};

export default App;
